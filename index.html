<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>PortionCal – Calorie Portion Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="styles.css">

</head>

<body>
<div class="container">

<h1>PortionCal</h1>
<div class="small">Calorie calculator for shared home-cooked meals</div>

<!-- PAN SELECTION -->
<div class="section">
  <h3>1) Select pan / pot</h3>

  <div id="panListMain" class="pan-list"></div>
  <br>

  <button id="moreButton" onclick="toggleMore()">Show more pans</button>

  <div id="morePans" class="pan-list hidden" style="margin-top:10px;"></div>
  <br>
  <label>Selected pan empty weight (grams)</label>
  <input type="number" id="panWeight" disabled inputmode="numeric" pattern="[0-9]*"/>
  <button id="saveButton" onclick="saveCustomWeight()" disabled>Save custom weight</button>
  <div class="small">Only the “Custom” pan can be edited.</div>
</div>

<!-- DISH INPUTS -->
<div class="section">
  <h3>2) Enter dish totals</h3>

  <label>Total weight on scale (pan + food, grams):</label>
  <input type="number" id="totalWeight" inputmode="decimal"/>

  <label>Total calories of cooked dish:</label>
  <input type="number" id="totalCalories" inputmode="decimal"/>

  <div class="result-box" id="baseOutput"></div>
</div>

<!-- SERVING CALCULATORS -->
<div class="section">
  <h3>3) Portion calculations</h3>

  <label>Desired calories → get serving weight (grams)</label>
  <input type="number" id="targetCalories" inputmode="decimal"/>
  <button onclick="handleTargetCalories()">Calculate serving weight</button>
  <br>

  <div class="result-box" id="targetResult"></div>

  <label>Serving weight (grams) → get calories</label>
  <input type="number" id="servingWeight" inputmode="decimal"/>
  <button onclick="handleServingWeight()">Calculate calories</button>

  <div class="result-box" id="servingResult"></div>
</div>

</div>

<script>
/* ---------- PAN DEFINITIONS ---------- */

let customWeight = Number(localStorage.getItem("customPanWeight")) || 1000;

const pansMain = [
  {name:"Pan S", weight:635, img:"media/small_pan.jpg"},
  {name:"Pan M", weight:756, img:"media/smallish_pan.jpg"},
  {name:"Pan L", weight:969, img:"media/medium_pan.jpg"},
  {name:"Pan XL", weight:1548, img:"media/huge_pan.jpg"},
  {name:"Frypan S", weight:799, img:"media/tiny_frypan.jpg"},
  {name:"Frypan M", weight:973, img:"media/medium_frypan.jpg"}
];

const pansMore = [
  {name:"Frypan L", weight:1301, img:"media/huge_frypan.jpg"},
  {name:"Custom", weight:customWeight, custom:true, img:"media/custom.png"}
];

let selected = { group:"main", index:0 };

function renderPans() {
  const main = document.getElementById("panListMain");
  const more = document.getElementById("morePans");

  main.innerHTML = "";
  more.innerHTML = "";

  pansMain.forEach((p,i)=>{
    const d=document.createElement("div");
    d.className="pan"+(selected.group==="main" && selected.index===i ? " selected":"");
    d.innerHTML=
      `<img src="${p.img}" alt="${p.name}">`+
      `<strong>${p.name}</strong><br>${p.weight} g`;
    d.onclick=()=>selectPan("main",i);
    main.appendChild(d);
  });

  pansMore.forEach(p => { if (p.custom) p.weight = customWeight; });

  pansMore.forEach((p,i)=>{
    const d=document.createElement("div");
    d.className="pan"+(selected.group==="more" && selected.index===i ? " selected":"");
    d.innerHTML=
      `<img src="${p.img}" alt="${p.name}">`+
      `<strong>${p.name}</strong><br>${p.weight} g`;
    d.onclick=()=>selectPan("more",i);
    more.appendChild(d);
  });

  updateWeightPanel();
}

function toggleMore(){
  const el = document.getElementById("morePans");
  el.classList.toggle("hidden");
  document.getElementById("moreButton").innerText =
    el.classList.contains("hidden") ? "Show more pans" : "Hide extra pans";
}

function selectPan(group,index){
  selected = {group,index};
  renderPans();
}

function getSelectedPan(){
  return selected.group==="main"
    ? pansMain[selected.index]
    : pansMore[selected.index];
}

/* ---------- EDIT PANEL BEHAVIOR ---------- */

function updateWeightPanel(){
  const pan=getSelectedPan();
  const input=document.getElementById("panWeight");
  const saveBtn=document.getElementById("saveButton");

  if(pan.custom){
    input.disabled=false;
    saveBtn.disabled=false;
    input.value=customWeight;
  } else {
    input.disabled=true;
    saveBtn.disabled=true;
    input.value=pan.weight;
  }
}

function saveCustomWeight(){
  const v=Number(document.getElementById("panWeight").value);
  if(!v || v<=0){
    alert("Enter valid custom pan weight");
    return;
  }
  customWeight=v;
  localStorage.setItem("customPanWeight", v);
  renderPans();
}

function updateResultVisibility() {
  ["baseOutput", "targetResult", "servingResult"].forEach(id => {
    const el = document.getElementById(id);
    if (el.innerHTML.trim() === "") {
      el.classList.remove("visible");
    } else {
      el.classList.add("visible");
    }
  });
}

/* ---------- BASE CALCULATION ---------- */

let caloriesPerGram = null;
let totalFoodWeight = null;

function calculateBase(){
  const totalWeight=Number(document.getElementById("totalWeight").value);
  const totalCalories=Number(document.getElementById("totalCalories").value);
  const pan=getSelectedPan();
  const panWeight=pan.custom ? customWeight : pan.weight;

  if(!totalWeight || !totalCalories){
    alert("Please enter total weight and total calories first.");
    return false;
  }

  totalFoodWeight = totalWeight - panWeight;
  if(totalFoodWeight<=0){
    alert("Food weight must be positive after subtracting pan weight");
    return false;
  }

  caloriesPerGram = totalCalories / totalFoodWeight;

  document.getElementById("baseOutput").innerHTML =
    `Total food weight: <b>${totalFoodWeight.toFixed(1)} g</b><br>
     Calories per gram: <b>${caloriesPerGram.toFixed(4)}</b><br>
     Calories per 100 g: <b>${(caloriesPerGram*100).toFixed(0)}</b>`;
 
  updateResultVisibility();
  return true;
}

/* ---------- TARGET CALCULATIONS ---------- */

function handleTargetCalories(){
  if(!calculateBase()) return;

  const target=Number(document.getElementById("targetCalories").value);
  if(!target){
    alert("Enter desired calories.");
    return;
  }

  const gramsNeeded = target / caloriesPerGram;
  const portion = gramsNeeded / totalFoodWeight;

  document.getElementById("targetResult").innerHTML =
    `To eat <b>${target}</b> kcal, serve <b>${gramsNeeded.toFixed(1)} g</b><br>
     That is <b>${portion.toFixed(3)}</b> portion`;

  document.getElementById("servingResult").innerHTML = "";
  updateResultVisibility();
}

function handleServingWeight(){
  if(!calculateBase()) return;

  const grams=Number(document.getElementById("servingWeight").value);
  if(!grams){
    alert("Enter serving weight in grams.");
    return;
  }

  const kcals = grams * caloriesPerGram;
  const portion = grams / totalFoodWeight;

  document.getElementById("servingResult").innerHTML =
    `${grams.toFixed(1)} g contains about <b>${kcals.toFixed(0)} kcal</b><br>
     That is <b>${portion.toFixed(2)}</b> portion`;

  document.getElementById("targetResult").innerHTML = "";
  updateResultVisibility();
}

/* ---------- KEYBOARD UX ---------- */

document.getElementById("targetCalories").addEventListener("keydown", e=>{
  if(e.key==="Enter") handleTargetCalories();
});

document.getElementById("servingWeight").addEventListener("keydown", e=>{
  if(e.key==="Enter") handleServingWeight();
});

document.getElementById("totalWeight").addEventListener("keydown", e=>{
  if(e.key==="Enter") calculateBase();
});

document.getElementById("totalCalories").addEventListener("keydown", e=>{
  if(e.key==="Enter") calculateBase();
});

/* initial render */
renderPans();
</script>

</body>
</html>

